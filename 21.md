### Основные механизмы безопасности в СУБД, учетные записи для входа и пользователи базы данных, серверные роли и роли базы данных

### **Часть 1. Архитектура безопасности СУБД**

**Три фундаментальных принципа безопасности (AAA):**

| Принцип | Описание | Реализация в СУБД |
| :--- | :--- | :--- |
| **Аутентификация (Authentication)** | "Кто вы?" Проверка личности | Логины, пароли, Windows Authentication, MFA |
| **Авторизация (Authorization)** | "Что вам разрешено?" Проверка прав | Права доступа, роли, схемы |
| **Аудит (Auditing)** | "Что вы делали?" Отслеживание действий | Журналирование, триггеры аудита, CDC |

#### **1.1. Модели безопасности**

**Диспетчерская модель (Mandatory Access Control - MAC):**
- Доступ на основе меток безопасности (секретно, совершенно секретно)
- Используется в государственных системах
- Жесткое централизованное управление

**Дискреционная модель (Discretionary Access Control - DAC):**
- Владелец объекта контролирует доступ (SQL Server, Oracle, PostgreSQL)
- Гибкость, но сложность управления в больших системах

**Ролевая модель (Role-Based Access Control - RBAC):**
- Права назначаются ролям, роли - пользователям
- Стандарт для корпоративных систем

---

### **Часть 2. Аутентификация: логины и пользователи**

#### **2.1. Уровни безопасности SQL Server**

```
ЭКЗЕМПЛЯР SQL SERVER (Instance Level)
      ↓
   ЛОГИНЫ (Logins) ←── Аутентификация
      ↓
   БАЗА ДАННЫХ (Database Level)
      ↓
   ПОЛЬЗОВАТЕЛИ (Users) ←── Авторизация
      ↓
   ОБЪЕКТЫ БАЗЫ ДАННЫХ (Objects)
```

#### **2.2. Логины (Logins) - аутентификация на уровне сервера**

**Типы логинов:**

| Тип | Описание | Синтаксис |
| :--- | :--- | :--- |
| **Windows Authentication** | Интеграция с Active Directory | `CREATE LOGIN [DOMAIN\username] FROM WINDOWS` |
| **SQL Server Authentication** | Внутренняя аутентификация | `CREATE LOGIN user1 WITH PASSWORD = 'StrongP@ssw0rd!'` |
| **Azure AD Authentication** | Для Azure SQL | `CREATE LOGIN [user@domain.com] FROM EXTERNAL PROVIDER` |

**Создание и управление логинами:**
```sql
-- 1. Windows Authentication (рекомендуется)
CREATE LOGIN [DOMAIN\jdoe] FROM WINDOWS;
CREATE LOGIN [DOMAIN\DevelopersGroup] FROM WINDOWS;

-- 2. SQL Server Authentication (когда нет AD)
CREATE LOGIN app_user WITH PASSWORD = 'P@ssw0rd!123',
    CHECK_POLICY = ON,
    CHECK_EXPIRATION = ON,
    DEFAULT_DATABASE = master,
    DEFAULT_LANGUAGE = русский;

-- 3. Политики паролей
ALTER LOGIN app_user WITH 
    PASSWORD = 'NewP@ssw0rd!456' MUST_CHANGE,
    CHECK_POLICY = ON,
    CHECK_EXPIRATION = ON;

-- 4. Блокировка/разблокировка
ALTER LOGIN app_user DISABLE;  -- Отключение
ALTER LOGIN app_user ENABLE;   -- Включение

-- 5. Удаление
DROP LOGIN app_user;

-- 6. Просмотр логинов
SELECT name, type_desc, is_disabled 
FROM sys.server_principals 
WHERE type IN ('S', 'U', 'G');
```

#### **2.3. Пользователи (Users) - авторизация на уровне базы данных**

**Логин ≠ Пользователь!**
- **Логин** - для входа на сервер (экземпляр)
- **Пользователь** - для работы в конкретной базе данных

```sql
-- Создание пользователя, связанного с логином
USE MyDatabase;
CREATE USER db_user FOR LOGIN app_user;

-- Пользователь без логина (contained user)
CREATE USER contained_user 
WITH PASSWORD = 'ContainedP@ss1',
    DEFAULT_SCHEMA = dbo;

-- Пользователь на основе сертификата
CREATE USER cert_user FOR CERTIFICATE my_cert;

-- Пользователь на основе ключа асимметричного шифрования
CREATE USER asym_key_user FOR ASYMMETRIC KEY my_key;

-- Сопоставление логина Windows с пользователем БД
CREATE USER [DOMAIN\jdoe] FOR LOGIN [DOMAIN\jdoe];

-- Управление пользователями
ALTER USER db_user WITH NAME = new_db_user;
ALTER USER db_user WITH DEFAULT_SCHEMA = sales;
DROP USER db_user;

-- Просмотр пользователей
SELECT name, type_desc, default_schema_name
FROM sys.database_principals
WHERE type IN ('S', 'U', 'G');
```

---

### **Часть 3. Авторизация: роли и права**

#### **3.1. Серверные роли (Server-Level Roles)**

**Фиксированные серверные роли (предопределенные):**

| Роль | Права | Описание |
| :--- | :--- | :--- |
| **sysadmin** | Все права на сервере | Администратор сервера |
| **serveradmin** | Настройка сервера | Может изменять конфигурацию |
| **securityadmin** | Управление безопасностью | Управление логинами и правами |
| **processadmin** | Управление процессами | Может завершать процессы |
| **dbcreator** | Создание/изменение БД | Создание и изменение БД |
| **diskadmin** | Управление дисками | Управление файлами БД |
| **bulkadmin** | Выполнение BULK INSERT | Массовая вставка данных |
| **public** | Базовые права | Все логины автоматически |

**Назначение серверных ролей:**
```sql
-- Добавление логина в серверную роль
ALTER SERVER ROLE sysadmin ADD MEMBER [DOMAIN\Admin];
ALTER SERVER ROLE dbcreator ADD MEMBER app_user;

-- Удаление из роли
ALTER SERVER ROLE sysadmin DROP MEMBER [DOMAIN\OldAdmin];

-- Создание пользовательской серверной роли (SQL Server 2012+)
CREATE SERVER ROLE ServerAuditor;
GRANT VIEW SERVER STATE TO ServerAuditor;
GRANT ALTER TRACE TO ServerAuditor;
ALTER SERVER ROLE ServerAuditor ADD MEMBER auditor_login;
```

#### **3.2. Роли базы данных (Database-Level Roles)**

**Фиксированные роли базы данных:**

| Роль | Права | Описание |
| :--- | :--- | :--- |
| **db_owner** | Все права в БД | Владелец базы данных |
| **db_securityadmin** | Управление безопасностью | Управление пользователями и правами |
| **db_accessadmin** | Управление доступом | Добавление/удаление пользователей |
| **db_backupoperator** | Резервное копирование | Создание бэкапов |
| **db_ddladmin** | Выполнение DDL | CREATE, ALTER, DROP объектов |
| **db_datawriter** | Изменение данных | INSERT, UPDATE, DELETE |
| **db_datareader** | Чтение данных | SELECT |
| **db_denydatawriter** | Запрет изменения | Запрет INSERT, UPDATE, DELETE |
| **db_denydatareader** | Запрет чтения | Запрет SELECT |
| **public** | Базовые права | Все пользователи БД |

**Назначение ролей БД:**
```sql
USE MyDatabase;

-- Добавление пользователя в роль
ALTER ROLE db_datareader ADD MEMBER db_user;
ALTER ROLE db_datawriter ADD MEMBER db_user;

-- Добавление в несколько ролей
EXEC sp_addrolemember 'db_datareader', 'db_user';
EXEC sp_addrolemember 'db_datawriter', 'db_user';

-- Удаление из роли
ALTER ROLE db_datareader DROP MEMBER db_user;

-- Создание пользовательской роли БД
CREATE ROLE ReportReaders;
GRANT SELECT ON SCHEMA::Sales TO ReportReaders;
GRANT SELECT ON SCHEMA::Marketing TO ReportReaders;
ALTER ROLE ReportReaders ADD MEMBER report_user1;
ALTER ROLE ReportReaders ADD MEMBER report_user2;
```

#### **3.3. Гранулярные права доступа (Granular Permissions)**

**Иерархия прав доступа:**
```
Сервер → База данных → Схема → Объект (таблица, процедура, функция) → Столбец
```

**Основные категории прав:**
```sql
-- Права на сервере
GRANT CONNECT SQL TO login1;
GRANT VIEW SERVER STATE TO login1;

-- Права на базе данных
GRANT CONNECT TO user1;
GRANT CREATE TABLE TO user1;
GRANT CREATE PROCEDURE TO user1;

-- Права на схеме
GRANT SELECT, INSERT ON SCHEMA::Sales TO user1;
GRANT EXECUTE ON SCHEMA::dbo TO user1;
GRANT ALTER ON SCHEMA::HR TO hr_admin;

-- Права на объекте
GRANT SELECT ON dbo.Employees TO user1;
GRANT INSERT, UPDATE ON dbo.Orders TO user2;
GRANT EXECUTE ON dbo.GetReport TO report_user;

-- Права на столбце
GRANT SELECT (EmployeeID, LastName, FirstName) 
ON dbo.Employees TO hr_assistant;
GRANT UPDATE (Salary) 
ON dbo.Employees TO hr_manager;
```

**Полный цикл управления правами:**
```sql
-- 1. Создание логина и пользователя
CREATE LOGIN developer WITH PASSWORD = 'DevP@ss1';
USE DevelopmentDB;
CREATE USER dev_user FOR LOGIN developer;

-- 2. Назначение ролей
ALTER ROLE db_datareader ADD MEMBER dev_user;
ALTER ROLE db_datawriter ADD MEMBER dev_user;

-- 3. Дополнительные права
GRANT CREATE TABLE TO dev_user;
GRANT CREATE VIEW TO dev_user;
GRANT EXECUTE ON SCHEMA::dbo TO dev_user;

-- 4. Запрет определенных действий
DENY ALTER ON SCHEMA::Security TO dev_user;
DENY DELETE ON dbo.AuditLog TO dev_user;

-- 5. Проверка прав
EXECUTE AS USER = 'dev_user';
-- Выполняем операции...
REVERT;

-- 6. Отзыв прав
REVOKE CREATE TABLE FROM dev_user;
REVOKE SELECT ON dbo.SensitiveData FROM dev_user;
```

---

### **Часть 4. Современные механизмы безопасности**

#### **4.1. Always Encrypted (Постоянное шифрование)**

**Принцип:** Данные шифруются **на стороне клиента**, в БД хранятся только зашифрованные значения.

**Типы:**
- **Детерминированное:** Одинаковые значения → одинаковый шифр (подходит для равенства)
- **Рандомизированное:** Каждое шифрование уникально (большая безопасность)

**Настройка:**
```sql
-- 1. Создание главного ключа столбца
CREATE COLUMN MASTER KEY MyCMK
WITH (
    KEY_STORE_PROVIDER_NAME = N'MSSQL_CERTIFICATE_STORE',
    KEY_PATH = N'CurrentUser/My/AAAAAAAAAAAAAAAAAAAAAAA'
);

-- 2. Создание ключа шифрования столбца
CREATE COLUMN ENCRYPTION KEY MyCEK
WITH VALUES (
    COLUMN_MASTER_KEY = MyCMK,
    ALGORITHM = N'RSA_OAEP',
    ENCRYPTED_VALUE = 0x01700000016...
);

-- 3. Создание таблицы с зашифрованными столбцами
CREATE TABLE Patients (
    PatientID INT PRIMARY KEY,
    SSN VARCHAR(11) COLLATE Latin1_General_BIN2
        ENCRYPTED WITH (
            ENCRYPTION_TYPE = DETERMINISTIC,
            ALGORITHM = N'AEAD_AES_256_CBC_HMAC_SHA_256',
            COLUMN_ENCRYPTION_KEY = MyCEK
        ),
    BirthDate DATE
        ENCRYPTED WITH (
            ENCRYPTION_TYPE = RANDOMIZED,
            ALGORITHM = N'AEAD_AES_256_CBC_HMAC_SHA_256',
            COLUMN_ENCRYPTION_KEY = MyCEK
        )
);
```

#### **4.2. Transparent Data Encryption (TDE)**

**Принцип:** Шифрование **файлов базы данных** на диске.

```sql
-- 1. Создание главного ключа базы данных
USE master;
CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'StrongMasterKeyP@ss!';

-- 2. Создание сертификата
CREATE CERTIFICATE MyServerCert 
WITH SUBJECT = 'My TDE Certificate';

-- 3. Включение TDE в пользовательской БД
USE MyDatabase;
CREATE DATABASE ENCRYPTION KEY
WITH ALGORITHM = AES_256
ENCRYPTION BY SERVER CERTIFICATE MyServerCert;

-- 4. Включение шифрования
ALTER DATABASE MyDatabase 
SET ENCRYPTION ON;

-- Проверка статуса
SELECT 
    db_name(database_id) as DatabaseName,
    encryption_state_desc,
    percent_complete
FROM sys.dm_database_encryption_keys;
```

#### **4.3. Row-Level Security (RLS) - безопасность на уровне строк**

**Принцип:** Фильтрация строк на основе контекста выполнения.

```sql
-- 1. Создание функции предиката
CREATE FUNCTION dbo.fn_UserDataAccessPredicate(@UserID AS INT)
RETURNS TABLE
WITH SCHEMABINDING
AS
RETURN (
    SELECT 1 AS access_result
    WHERE @UserID = USER_ID()  -- Текущий пользователь
       OR USER_NAME() = 'dbo'  -- Администратор
       OR IS_MEMBER('Managers') = 1  -- Член роли Managers
);

-- 2. Создание политики безопасности
CREATE SECURITY POLICY UserDataPolicy
ADD FILTER PREDICATE dbo.fn_UserDataAccessPredicate(UserID)
ON dbo.UserData
WITH (STATE = ON);

-- 3. Блокировочный предикат (запрет на изменение "чужих" строк)
CREATE SECURITY POLICY UserDataBlockPolicy
ADD BLOCK PREDICATE dbo.fn_UserDataAccessPredicate(UserID)
ON dbo.UserData AFTER INSERT;

-- Пользователь видит только свои строки
EXECUTE AS USER = 'user123';
SELECT * FROM dbo.UserData;  -- Только строки с UserID = 123
REVERT;
```

#### **4.4. Dynamic Data Masking (DDM) - маскирование данных**

```sql
-- Создание таблицы с маскированными полями
CREATE TABLE Customers (
    CustomerID INT PRIMARY KEY,
    Email VARCHAR(100) MASKED WITH (FUNCTION = 'email()'),
    Phone VARCHAR(20) MASKED WITH (FUNCTION = 'partial(2, "XXX-XX", 2)'),
    CreditCard VARCHAR(20) MASKED WITH (FUNCTION = 'partial(0, "XXXX-XXXX-XXXX-", 4)'),
    Salary DECIMAL(10,2) MASKED WITH (FUNCTION = 'random(1000, 5000)')
);

-- Назначение прав на снятие маскирования
GRANT UNMASK TO ManagerRole;

-- Для пользователя без UNMASK:
SELECT * FROM Customers;
-- Email: aXXX@XXXX.com
-- Phone: +7 XXX-XX-12
-- CreditCard: XXXX-XXXX-XXXX-1234
-- Salary: 3245.67 (случайное значение)
```

#### **4.5. Аудит (Auditing)**

```sql
-- Создание спецификации аудита сервера
CREATE SERVER AUDIT ServerAudit
TO FILE (
    FILEPATH = N'D:\Audit\',
    MAXSIZE = 1 GB,
    MAX_ROLLOVER_FILES = 10
)
WITH (
    QUEUE_DELAY = 1000,
    ON_FAILURE = CONTINUE
);

-- Включение аудита
ALTER SERVER AUDIT ServerAudit WITH (STATE = ON);

-- Создание спецификации аудита базы данных
CREATE DATABASE AUDIT SPECIFICATION DatabaseAudit
FOR SERVER AUDIT ServerAudit
ADD (SELECT, INSERT, UPDATE, DELETE ON SCHEMA::dbo BY public),
ADD (EXECUTE ON DATABASE::MyDatabase BY public)
WITH (STATE = ON);

-- Просмотр журналов аудита
SELECT * FROM sys.fn_get_audit_file('D:\Audit\*', NULL, NULL);
```

---

### **Часть 5. Практические сценарии безопасности**

#### **5.1. Сценарий: Многоуровневая безопасность для SaaS-приложения**

```sql
-- 1. Разделение по клиентам (тенантам)
CREATE ROLE Tenant1_Users;
CREATE ROLE Tenant2_Users;

-- 2. RLS для изоляции данных
CREATE FUNCTION dbo.fn_TenantAccessPredicate(@TenantID INT)
RETURNS TABLE
WITH SCHEMABINDING
AS
RETURN (
    SELECT 1 WHERE @TenantID = 
        CASE DATABASE_PRINCIPAL_ID()
            WHEN USER_ID('tenant1_user') THEN 1
            WHEN USER_ID('tenant2_user') THEN 2
            ELSE -1
        END
);

CREATE SECURITY POLICY TenantPolicy
ADD FILTER PREDICATE dbo.fn_TenantAccessPredicate(TenantID)
ON dbo.ApplicationData;

-- 3. Шифрование PII данных
ALTER TABLE dbo.Customers
ALTER COLUMN SSN VARCHAR(11) 
ADD MASKED WITH (FUNCTION = 'partial(0, "XXX-XX-", 4)');

-- 4. Аудит доступа к чувствительным данным
CREATE DATABASE AUDIT SPECIFICATION SensitiveDataAudit
FOR SERVER AUDIT ServerAudit
ADD (SELECT, UPDATE ON dbo.Customers BY public);
```

#### **5.2. Сценарий: Минимальные привилегии для веб-приложения**

```sql
-- 1. Специальный логин для приложения
CREATE LOGIN webapp_login WITH PASSWORD = 'AppP@ssw0rd!';

-- 2. Пользователь с минимальными правами
USE AppDatabase;
CREATE USER webapp_user FOR LOGIN webapp_login;

-- 3. Только необходимые права
GRANT EXECUTE ON SCHEMA::api TO webapp_user;  -- Только хранимые процедуры
GRANT SELECT ON dbo.LookupTables TO webapp_user;  -- Справочники

-- 4. Запрет прямого доступа к таблицам
DENY SELECT, INSERT, UPDATE, DELETE ON SCHEMA::dbo TO webapp_user;

-- 5. Аудит всех действий
CREATE DATABASE AUDIT SPECIFICATION WebAppAudit
FOR SERVER AUDIT ServerAudit
ADD (SCHEMA_OBJECT_ACCESS_GROUP);
```

#### **5.3. Сценарий: Управление доступом для команды разработки**

```sql
-- 1. Групповая учетная запись AD для разработчиков
CREATE LOGIN [DOMAIN\DevTeam] FROM WINDOWS;

-- 2. Специальная роль разработчика
USE DevelopmentDB;
CREATE ROLE Developers;

-- 3. Контролируемые права
GRANT CREATE TABLE, CREATE VIEW, CREATE PROCEDURE TO Developers;
GRANT ALTER ON SCHEMA::dev TO Developers;
GRANT SELECT ON SCHEMA::prod_readonly TO Developers;

-- 4. Запреты
DENY ALTER ON SCHEMA::prod TO Developers;
DENY DELETE ON ALL TABLES TO Developers;

-- 5. Добавление в роль
ALTER ROLE Developers ADD MEMBER [DOMAIN\DevTeam];
```

---

### **Часть 6. Мониторинг и обслуживание безопасности**

#### **6.1. Мониторинг безопасности**

```sql
-- Проверка пользователей с повышенными привилегиями
SELECT 
    dp.name AS UserName,
    dp.type_desc AS UserType,
    r.name AS RoleName
FROM sys.database_principals dp
LEFT JOIN sys.database_role_members rm ON dp.principal_id = rm.member_principal_id
LEFT JOIN sys.database_principals r ON rm.role_principal_id = r.principal_id
WHERE r.name IN ('db_owner', 'db_securityadmin')
   OR dp.name IN ('dbo', 'guest', 'INFORMATION_SCHEMA', 'sys')
ORDER BY r.name, dp.name;

-- Поиск пользователей без парольной политики
SELECT name, is_policy_checked, is_expiration_checked
FROM sys.sql_logins
WHERE is_policy_checked = 0 OR is_expiration_checked = 0;

-- Неиспользуемые логины
SELECT name, create_date, modify_date
FROM sys.server_principals
WHERE type IN ('S', 'U')
AND name NOT IN ('sa', 'public', 'NT SERVICE%', 'NT AUTHORITY%')
AND NOT EXISTS (
    SELECT 1 FROM sys.dm_exec_sessions
    WHERE login_name = name
);

-- Проверка прав на чувствительные объекты
EXECUTE AS USER = 'sensitive_user';
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');
REVERT;
```

#### **6.2. Автоматизация управления безопасностью**

```sql
-- Сценарий создания минимального пользователя
DECLARE @username NVARCHAR(100) = 'new_app_user';
DECLARE @password NVARCHAR(100) = 'TempP@ss123';
DECLARE @database NVARCHAR(100) = 'AppDB';

-- Создание логина
DECLARE @sql NVARCHAR(MAX) = '
CREATE LOGIN [' + @username + '] 
WITH PASSWORD = N''' + @password + ''',
    DEFAULT_DATABASE = [' + @database + '],
    CHECK_POLICY = ON,
    CHECK_EXPIRATION = ON;';

EXEC sp_executesql @sql;

-- Создание пользователя в БД
SET @sql = '
USE [' + @database + '];
CREATE USER [' + @username + '] FOR LOGIN [' + @username + '];
ALTER ROLE db_datareader ADD MEMBER [' + @username + '];
ALTER ROLE db_datawriter ADD MEMBER [' + @username + '];
GRANT EXECUTE ON SCHEMA::app TO [' + @username + '];';

EXEC sp_executesql @sql;
```

---

### **3. Заключение**

**Принципы эффективной безопасности в СУБД:**

1.  **Принцип наименьших привилегий:** Давать только необходимые права.
2.  **Разделение обязанностей:** Разные роли для разных задач.
3.  **Защита в глубину:** Многоуровневая безопасность.
4.  **Регулярный аудит:** Постоянный мониторинг действий.
5.  **Автоматизация:** Скрипты для управления безопасностью.

**Рекомендации по настройке безопасности:**

1.  **Отключайте учетную запись sa** или меняйте пароль.
2.  **Используйте Windows Authentication** где возможно.
3.  **Включайте политики паролей** для SQL-аутентификации.
4.  **Регулярно рецензируйте права доступа.**
5.  **Используйте шифрование** для чувствительных данных.
6.  **Настройте аудит** критических операций.
7.  **Используйте роли** вместо прямого назначения прав.
8.  **Тестируйте безопасность** так же, как функциональность.

**Современные тренды:**
- **Интеграция с корпоративными системами** (Active Directory, Azure AD)
- **Автоматическое управление правами** на основе политик
- **Шифрование по умолчанию** (Always Encrypted, TDE)
- **Безопасность на уровне данных** (RLS, DDM)
- **Непрерывный мониторинг** и машинное обучение для обнаружения аномалий

**Итог:** Безопасность СУБД — это не разовая настройка, а **непрерывный процесс**, требующий постоянного внимания, мониторинга и адаптации к изменяющимся угрозам и требованиям.