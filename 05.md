### Организация журнализации в СУБД

**Журнализация (ведение журналов предзаписи, Write-Ahead Logging - WAL)** — это фундаментальный механизм, обеспечивающий **надежность (durability)** и **атомарность (atomicity)** транзакций в соответствии с принципами ACID. Его основная идея: **никакое изменение данных не может быть записано в основное хранилище (таблицы, индексы) до того, как будет гарантированно сохранено в постоянном журнале.**

---

### **Часть 1. Назначение и ключевые свойства журнала транзакций**

**Основные цели журнализации:**

1.  **Обеспечение отказоустойчивости (Durability):** Гарантия, что подтверждённая транзакция (COMMIT) не будет потеряна даже при аппаратном сбое.
2.  **Поддержка атомарности транзакций (Atomicity):** Возможность отката незавершённой транзакции (ROLLBACK) и отката последствий сбойной транзакции при восстановлении.
3.  **Ускорение работы:** Позволяет откладывать запись «грязных» (изменённых) страниц данных на диск, так как вся информация для их восстановления уже есть в журнале. Это значительно уменьшает количество дорогостоящих случайных записей.
4.  **Поддержка репликации и восстановления на определённый момент времени (Point-in-Time Recovery - PITR):** Журнал — источник изменений для реплик и для восстановления БД до состояния до сбоя или ошибки пользователя.

**Ключевые свойства журнала (WAL):**

*   **Упорядоченность:** Записи в журнале имеют строгий порядок (LSN - Log Sequence Number).
*   **Добавочность (Append-Only):** Записи только добавляются в конец. Старые записи не перезаписываются, а архивируются или усекаются.
*   **Синхронность критичных записей:** Запись о фиксации транзакции (COMMIT) должна быть **синхронно** сброшена на диск (или в надежное хранилище) перед отправкой подтверждения клиенту. Это гарантирует Durability.

---

### **Часть 2. Физическая и логическая структура журнала**

#### **2.1. Физическая организация**

*   **Журнал как файл(ы):** Обычно один или несколько файлов на диске (например, `redo01.log`, `redo02.log` в Oracle; `ldf`-файл в SQL Server; сегмент `pg_wal` в PostgreSQL).
*   **Циклическое переиспользование:** Файлы журнала используются по кругу. Когда активный файл заполняется, СУБД переключается на следующий. Старый файл можно перезаписать, только если содержащиеся в нём изменения уже были применены к данным (**проведены на диск**) и файл более не нужен для восстановления.
*   **Группы журналов и зеркалирование:** В высоконагруженных системах журнал часто дублируется на несколько физических дисков (группы журналов в Oracle) для повышения отказоустойчивости.

#### **2.2. Логическая структура: записи журнала (Log Records)**

Каждая запись в журнале содержит информацию об одном изменении. Основные компоненты записи:

1.  **Уникальный идентификатор записи (LSN - Log Sequence Number):** Строго возрастающий номер, определяющий порядок.
2.  **Идентификатор транзакции (Transaction ID):** Какой транзакции принадлежит изменение.
3.  **Тип операции:** Что произошло (например, `INSERT`, `UPDATE`, `COMMIT`, `ABORT`, `CHECKPOINT`).
4.  **Идентификаторы изменяемых объектов:** Номер таблицы, страницы, строки.
5.  **Данные:**
    *   **Значения «до» изменения (undo data):** Для возможного отката (ROLLBACK) или отмены незафиксированных изменений при восстановлении.
    *   **Значения «после» изменения (redo data):** Для повторного применения (повтора) зафиксированных изменений, если они не попали в основное хранилище.
6.  **Указатели:** Ссылки на предыдущую/следующую запись этой же транзакции (для формирования цепочек отката).

---

### **Часть 3. Механизмы записи и контрольные точки (Checkpoint)**

#### **3.1. Процесс записи изменений (Типичный сценарий)**
1.  Транзакция изменяет строку в буферном пуле (в памяти).
2.  СУБД формирует **запись журнала (redo log record)**, содержащую достаточно информации, чтобы повторить это изменение.
3.  **Запись журнала принудительно сбрасывается (flush) в устойчивое хранилище журнала.** Это **синхронная операция** (критично для производительности, поэтому используют быстрые SSD, группы журналов).
4.  **Только после этого** клиенту может быть отправлено подтверждение `COMMIT`. Сами изменённые данные в таблицах могут оставаться в буферном пуле («грязные» страницы).
5.  Позже, фоновый процесс записи (например, `CHECKPOINT`) асинхронно сбрасывает «грязные» страницы из буфера на диск в основное хранилище.

#### **3.2. Контрольная точка (Checkpoint) — синхронизация журнала и данных**

**Проблема:** Если журнал будет расти бесконечно, время восстановления после сбоя станет неприемлемым (придётся проигрывать журнал с самого начала).

**Решение — механизм контрольных точек.**

*   **Что происходит при checkpoint:**
    1.  СУБД гарантированно записывает на диск **все «грязные» страницы**, изменённые транзакциями, которые были зафиксированы до определённого момента (LSN контрольной точки).
    2.  В журнал записывается **специальная запись `CHECKPOINT`**, которая содержит LSN, до которого данные уже согласованы (приведены в актуальное состояние на диске).
    3.  С этого момента **журнал, предшествующий этому LSN, больше не нужен для аварийного восстановления** и может быть перезаписан или архивирован.

*   **Типы контрольных точек:**
    *   **Согласованные (Fuzzy Checkpoint):** Не останавливает работу системы. Фиксирует информацию о «грязных» страницах, но их запись на диск происходит асинхронно и постепенно.
    *   **Полные/останавливающие:** Останавливает все операции для полной синхронизации данных на диске. Используется редко (например, перед обслуживанием).

*   **Триггеры для запуска checkpoint:**
    *   По времени (например, раз в 5 минут).
    *   По заполнению журнала на определенный процент.
    *   По количеству «грязных» страниц в буфере.
    *   Явная команда администратора.

---

### **Часть 4. Роль журнала в восстановлении после сбоев**

Процесс восстановления при следующем старте СУБД после аварийного завершения использует журнал и последнюю контрольную точку.

#### **Фазы восстановления:**

1.  **Анализ (Analysis):**
    *   Чтение журнала, начиная с последней записанной контрольной точки.
    *   Определение состояния всех транзакций на момент сбоя: какие были активны (незавершены), какие зафиксированы, но, возможно, их изменения не попали на диск.
    *   Построение списков: `UNDO` (транзакции для отката) и `REDO` (транзакции для повторного применения).

2.  **Повтор (Redo / Forward Recovery):**
    *   **Цель:** Гарантировать Durability. Применить все зафиксированные изменения, которые могли быть потеряны (не записаны из буфера в основные таблицы).
    *   **Действие:** Система последовательно, начиная с **самого старого LSN, который ещё не применён к данным на диске** (это определяется контрольной точкой), читает журнал и заново применяет операции из списка `REDO` к страницам данных на диске. Это гарантирует, что все эффекты зафиксированных транзакций сохранены.

3.  **Откат (Undo / Backward Recovery):**
    *   **Цель:** Гарантировать Atomicity. Откатить эффекты незавершённых (активных на момент сбоя) транзакций.
    *   **Действие:** Система проходит транзакции из списка `UNDO` в обратном порядке (от последней операции к первой) и отменяет их изменения, используя информацию `undo data` из записей журнала. База данных возвращается в состояние, как если бы эти транзакции никогда не начинались.

**После завершения этих трёх фаз** база данных переходит в **согласованное состояние**, и начинается нормальная работа.

#### **Схематично:**
```
Аварийный сбой
      ↓
Запуск СУБД → Восстановление
      ↓
АНАЛИЗ: Чтение журнала от последнего CHECKPOINT. Строим списки REDO/UNDO.
      ↓
REDO (ПОВТОР): Применяем ВСЕ зафиксированные изменения от старейшего необходимого LSN.
      ↓
UNDO (ОТКАТ): Откатываем ВСЕ незафиксированные на момент сбоя транзакции.
      ↓
База данных в согласованном состоянии → Открыта для пользователей.
```

---

### **Заключение**

Журнализация по принципу WAL — это краеугольный камень надёжных СУБД. Она представляет собой разумный компромисс:
*   **Между производительностью и надёжностью:** За счёт асинхронной записи данных и синхронной записи компактного журнала.
*   **Между скоростью работы и скоростью восстановления:** Контрольные точки ограничивают объём журнала, необходимый для восстановления.

**Без эффективного механизма WAL** были бы невозможны ни устойчивые транзакции, ни высокая производительность систем, работающих с изменяемыми данными.